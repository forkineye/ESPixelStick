; PlatformIO Project Configuration File for ESPixelStick
; https://docs.platformio.org/page/projectconf.html
;
; Local configuration should be done in platformio_user.ini

[platformio]
default_envs = espsv3, d1_mini, d32_pro, d32_pro_eth, esp32_cam, esp32_ttgo_t8, d1_mini32, d1_mini32_eth, esp32_wt32eth01, esp32_quinled_quad, esp32_quinled_quad_eth, esp32_quinled_uno, esp32_quinled_uno_eth, esp01s, d1_mini_mhetesp32minikit
src_dir = ./ESPixelStick
data_dir = ./ESPixelStick/data
build_cache_dir = ~/.buildcache
; packages_dir = ./.pio/packages
; cache_dir = ./.pio/cache
extra_configs = platformio_user.ini

;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~;
; Baseline build environment                                         ;
; https://docs.platformio.org/en/latest/projectconf/section_env.html ;
;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~;
[env]
framework = arduino
monitor_speed = 115200
upload_speed = 921600
lib_compat_mode = strict
lib_deps =
    adafruit/Adafruit PWM Servo Driver Library @ 2.4.0
    bblanchon/ArduinoJson @ 6.18.5
    bblanchon/StreamUtils @ 1.6.2
    djgrrr/Int64String @ 1.1.1
    https://github.com/forkineye/ESPAsyncWebServer.git#v2.0.0
    forkineye/ESPAsyncE131 @ 1.0.4
    ottowinter/AsyncMqttClient-esphome @ 0.8.6
    https://github.com/natcl/Artnet                         ; pull latest
    https://github.com/MartinMueller2003/Espalexa           ; pull latest
lib_ignore =
    Ethernet ; Remove once Art-Net is fixed / replaced to not depend on Ethernet in lib config
extra_scripts =
    pre:.scripts/pio-version.py
    .scripts/download_fs.py
; build_type = debug
upload_port = com6    

;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~;
; ESP8266 defaults for 4MB flash                                     ;
; https://docs.platformio.org/en/latest/platforms/espressif8266.html ;
;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~;
[esp8266]
platform = espressif8266 @ 3.2.0 ; Arduino Core 3.0.2
board_build.f_cpu = 160000000L
board_build.filesystem = littlefs
board_build.ldscript = eagle.flash.4m2m.ld
monitor_filters = esp8266_exception_decoder
build_flags =
    ${env.build_flags}
;    -D PIO_FRAMEWORK_ARDUINO_ESPRESSIF_SDK22x_190313
;    -D PIO_FRAMEWORK_ARDUINO_ESPRESSIF_SDK3
;    -D PIO_FRAMEWORK_ARDUINO_LWIP2_HIGHER_BANDWIDTH
    -D PIO_FRAMEWORK_ARDUINO_LWIP2_HIGHER_BANDWIDTH_LOW_FLASH
    -D NDEBUG        ; https://github.com/esp8266/Arduino/issues/3978
    -D FP_IN_IROM    ; https://github.com/esp8266/Arduino/pull/7180
;    -D PIO_FRAMEWORK_ARDUINO_MMU_CACHE16_IRAM48
;    -D VTABLES_IN_IRAM
lib_deps =
    ${env.lib_deps}
    me-no-dev/ESPAsyncUDP @ 0.0.0-alpha+sha.697c75a025
    ottowinter/ESPAsyncTCP-esphome @ 1.2.3

;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~;
; ESP32 defaults for 4MB flash                                     ;
; https://docs.platformio.org/en/latest/platforms/espressif32.html ;
;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~;
[esp32]
platform = espressif32
board_build.filesystem = littlefs
board_build.partitions = ESP32_partitions.csv
monitor_filters = esp32_exception_decoder
build_flags = ${env.build_flags}
lib_deps =
    ${env.lib_deps}
    esphome/AsyncTCP-esphome @ 1.2.2
extra_scripts = ${env.extra_scripts}
                .scripts/replace_fs.py

;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~;
; ESP32 pulling from upstream core ;
;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~;
[esp32git]
extends = esp32
build_flags = ${esp32.build_flags}
platform  = https://github.com/platformio/platform-espressif32.git#feature/arduino-idf-master
platform_packages =
;    framework-arduinoespressif32 @ https://github.com/espressif/arduino-esp32.git#master
;    framework-arduinoespressif32 @ https://github.com/espressif/arduino-esp32.git#4da1051266c2d664846f9eb7bc0d8936cb4b0848 ; Master @ March 3 2022
;    framework-arduinoespressif32 @ https://github.com/espressif/arduino-esp32.git#78b2df74f5cd9bcdc67cec884e0c25b2ec8ffc5e ; Jan 18 New IDF Breaks UART
;    framework-arduinoespressif32 @ https://github.com/espressif/arduino-esp32.git#77756d8a06e869875438e34ca6056738f98e5938 ; Jan 17 - Fast Good.
;    framework-arduinoespressif32 @ https://github.com/espressif/arduino-esp32.git#2.0.2 ; runs real slow
;    framework-arduinoespressif32 @ https://github.com/espressif/arduino-esp32.git#2.0.1 ; Has general issues
    framework-arduinoespressif32 @ https://github.com/espressif/arduino-esp32.git#2.0.0 ; SD card not stable on cam card

;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~;
; Build targets (environments) ;
;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~;

; ESPixelStick V3
[env:espsv3]
extends = esp8266
board = d1_mini
build_flags =
    ${esp8266.build_flags}
    -D BOARD_ESPS_V3

; Generic Wemos D1 R2 Mini
[env:d1_mini]
extends = esp8266
board = d1_mini
build_flags =
    ${esp8266.build_flags}

; Generic Wemos D1 R2 Mini
[env:esp01s]
extends = esp8266
board = d1_mini
build_flags =
    ${esp8266.build_flags}
    -D BOARD_ESP01S

; Lolin D32 Pro
[env:d32_pro]
extends = esp32git
board = lolin_d32_pro
build_flags =
    ${esp32git.build_flags}
    -D BOARD_ESP32_LOLIN_D32_PRO
    -D BOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -mfix-esp32-psram-cache-strategy=memw
;    -D CONFIG_ESP_SYSTEM_PANIC_GDBSTUB -O0 -ggdb3 -g3
    -Wl,-Map,output.map
; debug_tool              = esp-prog
; upload_protocol         = esp-prog
; debug_init_break        = tbreak setup
; Lolin D32 Pro with Ethernet
[env:d32_pro_eth]
extends = esp32git
board = lolin_d32_pro
build_flags =
    ${esp32git.build_flags}
    -D BOARD_ESP32_LOLIN_D32_PRO_ETH
    -D BOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -mfix-esp32-psram-cache-strategy=memw

; ESP32 CAM
[env:esp32_cam]
extends = esp32git
board = esp32cam
monitor_rts = 0
monitor_dtr = 0
build_flags =
    ${esp32git.build_flags}
    -D BOARD_ESP32_CAM
    -D BOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -mfix-esp32-psram-cache-strategy=memw

; ESP32 TTGO-T8 V1.x
[env:esp32_ttgo_t8]
extends = esp32git
board = ttgo-t7-v14-mini32 ; use until platformio adds TTGO-T8
monitor_rts = 0
monitor_dtr = 0
build_flags =
    ${esp32git.build_flags}
    -D BOARD_ESP32_TTGO_T8
    -D BOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -mfix-esp32-psram-cache-strategy=memw

; Generic Wemos D1 Mini 32
[env:d1_mini32]
extends = esp32git
board = wemos_d1_mini32
build_flags =
    ${esp32git.build_flags}
    -D BOARD_ESP32_D1_MINI
    -D BOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -mfix-esp32-psram-cache-strategy=memw

; Generic Wemos D1 Mini 32
[env:d1_mini32_eth]
extends = esp32git
board = wemos_d1_mini32
build_flags =
    ${esp32git.build_flags}
    -D BOARD_ESP32_D1_MINI_ETH
    -D BOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -mfix-esp32-psram-cache-strategy=memw

; WT 32 ETH 01
[env:esp32_wt32eth01]
extends = esp32git
board = esp32doit-D evkit-v1
build_flags =
    ${esp32git.build_flags}
    -D BOARD_ESP32_WT32ETH01
    -D BOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -mfix-esp32-psram-cache-strategy=memw

[env:esp32_quinled_quad]
extends = esp32git
board = wemos_d1_mini32
build_flags =
    ${esp32git.build_flags}
    -D BOARD_ESP32_QUINLED_QUAD

[env:esp32_quinled_quad_eth]
extends = esp32git
board = wemos_d1_mini32
build_flags =
    ${esp32git.build_flags}
    -D BOARD_ESP32_QUINLED_QUAD_ETH

[env:esp32_quinled_uno]
extends = esp32git
board = wemos_d1_mini32
build_flags =
    ${esp32git.build_flags}
    -D BOARD_ESP32_QUINLED_UNO

[env:esp32_quinled_uno_eth]
extends = esp32git
board = wemos_d1_mini32
build_flags =
    ${esp32git.build_flags}
    -D BOARD_ESP32_QUINLED_UNO_ETH

[env:d1_mini_mhetesp32minikit]
extends = esp32git
board = mhetesp32minikit
build_flags =
    ${esp32git.build_flags}
    -D BOARD_ESP32_QUINLED_UNO_ETH
